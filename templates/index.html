// Инициализация Telegram Web App
let tg = window.Telegram.WebApp;
tg.expand();
tg.enableClosingConfirmation();

// Тема
document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#5288c1');
document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f4f4f5');

// Глобальные переменные
const users = {
    'sup1': { password: 'sup1$', role: 'super', name: 'Супервізор' },
    'rus1': { password: 'rus1$', role: 'tech', name: 'Руслан', tech: 'ruslan' },
    'callcentr1': { password: 'callcentr1$', role: 'callcenter', name: 'Call-центр' },
    'igor1': { password: 'igor1$', role: 'tech', name: 'Ігор', tech: 'igor' },
    'dmut1': { password: 'dmut1$', role: 'tech', name: 'Дмитро', tech: 'dmutro' },
    'texdir1': { password: 'texdir1$', role: 'texdir', name: 'Тех. Директор' }
};

let currentUser = null;
let currentProblem = '';
let selectedAparat = null; // {id: 123, addr: 'Адреса', tech: 'ruslan'}
let currentTasks = [];

// --- UTILS ---

// Показать/скрыть лоадер
function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
function hideLoading() { document.getElementById('loading').classList.add('hidden'); }

// Отображение сообщения Telegram
function showTgAlert(text, callback = null) {
    if (tg.showAlert) {
        tg.showAlert(text, callback);
    } else {
        alert(text);
        if (callback) callback();
    }
}

// Переключение экранов
function hideAllScreens() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
}

function showCallCenterCabinet() {
    hideAllScreens();
    document.getElementById('callcenter-cabinet').classList.add('active');
}
function showTechCabinet() {
    hideAllScreens();
    document.getElementById('tech-cabinet').classList.add('active');
    document.getElementById('tech-cabinet-title').innerText = `Кабінет ${currentUser.name}`;
    loadTasks();
}
function showTexdirCabinet() {
    hideAllScreens();
    document.getElementById('texdir-cabinet').classList.add('active');
}
function showSuperCabinet() {
    hideAllScreens();
    document.getElementById('super-cabinet').classList.add('active');
    document.getElementById('super-cabinet-title').innerText = `Кабінет ${currentUser.name}`;
    loadTasks();
}

// --- API CALLS ---

// 1. Загрузка задач (для всех ролей, кроме TexDir)
async function loadTasks() {
    if (!currentUser) return;
    showLoading();

    const role = currentUser.role;
    const tech_name = currentUser.tech || null; // Для техников

    try {
        const response = await fetch('/api/get_tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: role, tech_name: tech_name })
        });

        const data = await response.json();

        if (data.status === 'ok') {
            currentTasks = data.tasks;
            renderTasks(currentTasks);
        } else {
            showTgAlert(`Помилка завантаження задач: ${data.message}`);
            console.error('API Error:', data.message);
        }
    } catch (error) {
        showTgAlert(`Помилка зв'язку з сервером: ${error.message}`);
        console.error('Fetch Error:', error);
    } finally {
        hideLoading();
    }
}

// 2. Отправка обычной задачи (CallCenter/Super)
async function sendTaskToServer() {
    if (!selectedAparat || !currentProblem) {
        showTgAlert("Будь ласка, оберіть апарат та тип проблеми.");
        return;
    }

    const zavdanya_text = document.getElementById('task-text-input').value.trim();
    if (!zavdanya_text) {
        showTgAlert("Будь ласка, введіть детальний опис завдання.");
        return;
    }

    showLoading();
    
    try {
        const payload = {
            id_terem: selectedAparat.id,
            adres: selectedAparat.addr,
            zavdanya: `${currentProblem}: ${zavdanya_text}`,
        };

        const response = await fetch('/api/create_task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        
        if (data.status === 'ok') {
            closeAddressModal();
            showTgAlert(data.message, loadTasks); // Обновляем список после создания
        } else {
            showTgAlert(`Помилка створення задачі: ${data.message}`);
        }
    } catch (error) {
        showTgAlert(`Помилка зв'язку з сервером: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// 3. Отправка задачи с термином (TexDir)
async function sendTerminToServer() {
    const terminDays = parseInt(document.getElementById('termin-days-input').value);
    const zavdanyaText = document.getElementById('termin-text-input').value.trim();

    if (!selectedAparat || !terminDays || !zavdanyaText || terminDays <= 0) {
        showTgAlert("Будь ласка, заповніть усі поля коректно.");
        return;
    }

    showLoading();
    
    try {
        const payload = {
            id_terem: selectedAparat.id,
            adres: selectedAparat.addr,
            zavdanya: zavdanyaText,
            termin: terminDays // Количество дней
        };

        const response = await fetch('/api/create_termin_task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        
        if (data.status === 'ok') {
            closeTerminModal();
            showTgAlert(data.message);
        } else {
            showTgAlert(`Помилка створення задачі: ${data.message}`);
        }
    } catch (error) {
        showTgAlert(`Помилка зв'язку з сервером: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// 4. Закрытие задачи (Tech)
async function closeTask(taskId) {
    showTgAlert(`Ви впевнені, що хочете закрити завдання #${taskId}?`, async () => {
        showLoading();
        try {
            const response = await fetch('/api/close_task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_id: taskId })
            });

            const data = await response.json();
            
            if (data.status === 'ok') {
                showTgAlert(data.message, loadTasks); // Обновляем список после закрытия
            } else {
                showTgAlert(`Помилка закриття задачі: ${data.message}`);
            }
        } catch (error) {
            showTgAlert(`Помилка зв'язку з сервером: ${error.message}`);
        } finally {
            hideLoading();
        }
    });
}

// 5. Запуск отчета (Super)
async function generateReport() {
    const startDate = document.getElementById('report-start-date').value;
    const endDate = document.getElementById('report-end-date').value;

    if (!startDate || !endDate) {
        showTgAlert("Будь ласка, оберіть початкову та кінцеву дату.");
        return;
    }

    showLoading();
    
    // Временно отключим API и будем выводить заглушку, пока API не будет доработано
    /*
    try {
        const response = await fetch('/api/run_report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ report_type: 'all', start_date: startDate, end_date: endDate })
        });

        const data = await response.json();
        
        if (data.status === 'ok') {
            document.getElementById('report-data').innerText = data.report;
            document.getElementById('report-output').classList.remove('hidden');
        } else {
            showTgAlert(`Помилка формування звіту: ${data.message}`);
            document.getElementById('report-data').innerText = `Помилка: ${data.message}`;
            document.getElementById('report-output').classList.remove('hidden');
        }
    } catch (error) {
        showTgAlert(`Помилка зв'язку з сервером: ${error.message}`);
    } finally {
        hideLoading();
    }
    */
    
    // --- ЗАГЛУШКА ДЛЯ ОТЧЕТА ---
    setTimeout(() => {
        const dummyReport = `*** ЗВІТ ПРО ВИКОНАННЯ ЗАВДАНЬ ***\n\nПеріод: ${startDate} по ${endDate}\n\nВсього відкрито: 45\nВсього закрито: 30\n\n- Руслан: 12 закритих\n- Ігор: 15 закритих\n- Дмитро: 3 закритих\n\n--- Деталі ---\nЗавдання #123 (Інкасація, Антонича, 6) - Закрито\nЗавдання #124 (Ремонт, Величковського, 58) - Закрито\n...`;
        document.getElementById('report-data').innerText = dummyReport;
        document.getElementById('report-output').classList.remove('hidden');
        hideLoading();
        showTgAlert("Звіт сформовано успішно (Дані є тестовими).");
    }, 1000);
    // --- КОНЕЦ ЗАГЛУШКИ ---
}

// --- RENDERING ---

// Отрисовка списка задач для кабинетов (Super/Tech/CallCenter)
function renderTasks(tasks) {
    const isTech = currentUser.role === 'tech';
    const listId = isTech ? 'tech-tasks-list' : 'super-tasks-list';
    const listElement = document.getElementById(listId);
    listElement.innerHTML = '';
    
    const openTasks = tasks.filter(t => t.status === 'open');
    const closedTasks = tasks.filter(t => t.status === 'closed');
    
    // Обновляем статистику (только для Super)
    if (currentUser.role === 'super') {
        document.getElementById('stat-active-tasks').innerText = openTasks.length;
        // Здесь можно добавить логику для "закрыто сегодня"
        document.getElementById('stat-closed-today').innerText = closedTasks.filter(t => {
            if (t.date_time_close) {
                const closeDate = new Date(t.date_time_close.split(' ')[0]);
                const today = new Date();
                return closeDate.toDateString() === today.toDateString();
            }
            return false;
        }).length;
    }

    // Если нет открытых задач
    if (openTasks.length === 0 && isTech) {
        document.getElementById('tech-no-tasks').classList.remove('hidden');
    } else if (isTech) {
        document.getElementById('tech-no-tasks').classList.add('hidden');
    }
    
    // Рендерим открытые задачи
    openTasks.forEach(task => {
        const taskElement = document.createElement('div');
        taskElement.className = `task-item status-${task.status} ${task.is_overdue ? 'overdue' : ''}`;
        
        let overdue_label = task.is_overdue ? '<span class="overdue-label">Просрочено</span>' : '';
        let termin_info = task.termin_days > 0 ? `Термін: ${task.termin_days} дн. (до ${task.due_date})` : 'Термін: 1 дн.';
        let remaining_info = task.is_overdue ? 
            `<span class="text-danger">Просрочено на ${Math.abs(task.remaining_days)} дн.</span>` :
            `<span class="text-success">Залишилось: ${task.remaining_days} дн.</span>`;
            
        taskElement.innerHTML = `
            <div class="task-header">
                <span class="task-id">#${task.id}</span>
                <span class="aparat-id">ID: ${task.id_terem}</span>
                ${overdue_label}
            </div>
            <p class="task-address">${task.adres}</p>
            <p class="task-text">${task.zavdanya}</p>
            <div class="task-meta">
                <p>Технік: <strong>${task.texnik}</strong></p>
                <p>${termin_info}</p>
                <p>${task.termin_days > 1 ? remaining_info : ''}</p>
            </div>
            ${isTech ? `<button class="btn-success btn-small" onclick="closeTask(${task.id})">Закрити</button>` : ''}
        `;
        listElement.appendChild(taskElement);
    });
    
    // Рендерим историю (закрытые задачи) только для Техника
    if (isTech) {
        const historyListElement = document.getElementById('tech-history-list');
        historyListElement.innerHTML = '';
        
        if (closedTasks.length === 0) {
            document.getElementById('tech-no-history').classList.remove('hidden');
        } else {
            document.getElementById('tech-no-history').classList.add('hidden');
        }
        
        closedTasks.forEach(task => {
            const taskElement = document.createElement('div');
            taskElement.className = 'task-item status-closed';
            taskElement.innerHTML = `
                <div class="task-header">
                    <span class="task-id">#${task.id}</span>
                    <span class="aparat-id">ID: ${task.id_terem}</span>
                </div>
                <p class="task-address">${task.adres}</p>
                <p class="task-text">${task.zavdanya}</p>
                <div class="task-meta">
                    <p>Закрито: <strong>${task.date_time_close}</strong></p>
                </div>
            `;
            historyListElement.appendChild(taskElement);
        });
    }

    // Рендерим закрытые задачи для Супервизора (в отдельном блоке, если нужно)
    if (currentUser.role === 'super') {
         // Для Super будем держать все в одном списке
         closedTasks.forEach(task => {
            const taskElement = document.createElement('div');
            taskElement.className = 'task-item status-closed';
            
            taskElement.innerHTML = `
                <div class="task-header">
                    <span class="task-id">#${task.id}</span>
                    <span class="aparat-id">ID: ${task.id_terem}</span>
                </div>
                <p class="task-address">${task.adres}</p>
                <p class="task-text">${task.zavdanya}</p>
                <div class="task-meta">
                    <p>Технік: <strong>${task.texnik}</strong></p>
                    <p>Закрито: <strong>${task.date_time_close}</strong></p>
                </div>
            `;
            listElement.appendChild(taskElement);
        });
    }
}


// --- ADDRESS SEARCH LOGIC ---

// Основная функция поиска адресов
async function searchAddresses(query) {
    if (query.length < 3) return [];
    
    try {
        const response = await fetch('/api/search_aparat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query })
        });
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Search API Error:', error);
        return [];
    }
}

// Настройка поиска для поля ввода
function setupSearch(inputElement, resultsDivId, selectCallback) {
    const resultsDiv = document.getElementById(resultsDivId);
    let timeout = null;

    inputElement.oninput = () => {
        resultsDiv.innerHTML = '';
        const query = inputElement.value.trim();
        if (query.length < 3) {
            resultsDiv.classList.remove('active');
            return;
        }

        clearTimeout(timeout);
        timeout = setTimeout(async () => {
            const results = await searchAddresses(query);
            resultsDiv.innerHTML = '';
            
            if (results.length > 0) {
                results.forEach(aparat => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerText = `${aparat.addr} (ID: ${aparat.id}, Технік: ${aparat.tech})`;
                    resultItem.onclick = () => selectCallback(aparat, resultsDiv, inputElement);
                    resultsDiv.appendChild(resultItem);
                });
                resultsDiv.classList.add('active');
            } else {
                resultsDiv.classList.remove('active');
            }
        }, 300);
    };

    // Скрываем результаты при потере фокуса
    inputElement.onblur = () => {
        setTimeout(() => resultsDiv.classList.remove('active'), 200);
    };
    
    inputElement.onfocus = () => {
        if (resultsDiv.children.length > 0) {
             resultsDiv.classList.add('active');
        }
    };
}

// Колбэк для выбора адреса в модальном окне "Обычная задача"
function selectAddress(aparat, resultsDiv, inputElement) {
    selectedAparat = aparat;
    inputElement.value = aparat.addr; // Устанавливаем адрес в поле ввода
    resultsDiv.classList.remove('active');
    
    // Показываем информацию о выбранном аппарате
    document.getElementById('selected-address-text').innerText = aparat.addr;
    document.getElementById('selected-aparat-id').innerText = aparat.id;
    document.getElementById('selected-address-info').classList.remove('hidden');
}

// Колбэк для выбора адреса в модальном окне "Задача с термином"
function selectTerminAddress(aparat, resultsDiv, inputElement) {
    selectedAparat = aparat;
    inputElement.value = aparat.addr; // Устанавливаем адрес в поле ввода
    resultsDiv.classList.remove('active');
    
    // Показываем информацию о выбранном аппарате
    document.getElementById('selected-termin-address-text').innerText = aparat.addr;
    document.getElementById('selected-termin-aparat-id').innerText = aparat.id;
    document.getElementById('selected-termin-address-info').classList.remove('hidden');
}


// --- MAIN LOGIC ---

// Логин
function handleLogin() {
    const login = document.getElementById('login-input').value.trim();
    const password = document.getElementById('password-input').value.trim();
    const errorMsg = document.getElementById('login-error');
    
    errorMsg.classList.add('hidden');
    
    const user = users[login];
    
    if (user && user.password === password) {
        currentUser = user;
        document.getElementById('login-screen').classList.remove('active');
        
        // Переключаем на нужный кабинет
        if (user.role === 'super') {
            showSuperCabinet();
        } else if (user.role === 'tech') {
            showTechCabinet();
        } else if (user.role === 'callcenter') {
            showCallCenterCabinet();
        } else if (user.role === 'texdir') {
            showTexdirCabinet();
        }
        
        // Устанавливаем кнопку "Выход"
        tg.MainButton.setText('Вийти');
        tg.MainButton.show();
        
    } else {
        errorMsg.innerText = 'Невірний логін або пароль.';
        errorMsg.classList.remove('hidden');
    }
}

// Переключение вкладок Супервизора
function showSuperTab(tabId) {
    document.querySelectorAll('#super-cabinet .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('#super-cabinet .tab-btn').forEach(b => b.classList.remove('active'));
    
    document.getElementById(tabId).classList.add('active');
    document.querySelector(`.tab-btn[onclick="showSuperTab('${tabId}')"]`).classList.add('active');
}

// Переключение вкладок Техника
function showTechTab(tabId) {
    document.querySelectorAll('#tech-cabinet .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('#tech-cabinet .tab-btn').forEach(b => b.classList.remove('active'));
    
    document.getElementById(tabId).classList.add('active');
    document.querySelector(`.tab-btn[onclick="showTechTab('${tabId}')"]`).classList.add('active');
}

// Открытие меню выбора проблемы
function openProblemMenu() {
    // Если это TexDir, то сразу переходим к модалу термина
    if (currentUser && currentUser.role === 'texdir') {
        openTerminModal();
    } else {
        // Для Super/CallCenter
        document.getElementById('problem-menu').classList.remove('hidden');
    }
}

// Открытие модального окна "Задача с термином"
function openTerminModal() {
    document.getElementById('problem-menu').classList.add('hidden'); // Закрываем меню проблем
    document.getElementById('address-modal').classList.add('hidden'); // Закрываем обычный модал
    document.getElementById('termin-modal').classList.remove('hidden');

    // Сброс полей
    document.getElementById('termin-text-input').value = '';
    document.getElementById('termin-days-input').value = 1;
    document.getElementById('termin-addr-input').value = '';
    
    selectedAparat = null; // Сброс выбранного аппарата
    document.getElementById('selected-termin-address-info').classList.add('hidden');

    // Настраиваем поиск
    setupSearch(document.getElementById('termin-addr-input'), 'termin-search-results', selectTerminAddress);
}

function closeTerminModal() {
     document.getElementById('termin-modal').classList.add('hidden');
}


function closeAddressModal() {
    document.getElementById('address-modal').classList.add('hidden');
    // Сбрасываем выбранную проблему и аппарат
    currentProblem = '';
    selectedAparat = null;
    document.getElementById('selected-address-info').classList.add('hidden');
}


function handleReportHelp() {
    showTgAlert('Функціонал звітів дозволяє:\n\n1. Сформувати загальний звіт про роботу (вкладка "Звіти").\n2. Отримати статистику активних/закритих завдань (вкладка "Статистика").\n\nДати використовуються для фільтрації виконаних завдань.');
}

function logout() {
    // Перезагрузка для сброса состояния
    location.reload();
}

// --- Инициализация и События ---

// События
tg.onEvent('mainButtonClicked', logout);

// Закрытие модальных окон по клику вне контента
document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { 
    if(e.target === m) {
        m.classList.add('hidden'); 
        // Если это окно адреса, сбросить выбор
        if (m.id === 'address-modal') {
            closeAddressModal();
        } else if (m.id === 'termin-modal') {
             closeTerminModal();
        }
    } 
}));

// Обработка клика на кнопки выбора проблемы
document.querySelectorAll('.problem-btn').forEach(btn => btn.onclick = (e) => {
    e.preventDefault(); // Остановим дефолтное поведение
    
    const problemType = btn.dataset.problem;
    
    // Специальный случай: "Завдання з терміном"
    if (problemType === 'Завдання з терміном') {
        openTerminModal();
        return;
    }

    currentProblem = problemType;
    document.getElementById('problem-menu').classList.add('hidden');
    
    // Обнуляем поля перед открытием
    document.getElementById('task-text-input').value = '';
    document.getElementById('selected-address-info').classList.add('hidden');

    // Открываем модал адреса для обычной задачи
    document.getElementById('address-modal').classList.remove('hidden');
    document.getElementById('selected-problem-name').innerText = problemType;
    document.getElementById('address-input').value = '';
    selectedAparat = null;
    
    // Настраиваем поиск адреса
    setupSearch(document.getElementById('address-input'), 'search-results', selectAddress);
});

// Дополнительная логика, если нужно открыть модал адреса напрямую
// Эта функция больше не используется напрямую, но оставлю ее как заглушку
/* function openAddressModal(problem) {
    document.getElementById('address-modal').classList.remove('hidden');
    document.getElementById('selected-problem-name').innerText = problem;
    document.getElementById('address-input').value = '';
    selectedAparat = null;
    setupSearch(document.getElementById('address-input'), 'search-results', selectAddress);
}
*/

// Вход по Enter
document.getElementById('password-input').addEventListener('keypress', e => { 
    if(e.key === 'Enter') handleLogin(); 
});

console.log('App Ready');